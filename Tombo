rule detect_modification:
    input:
        fast5="data/{sample}",
        ref="data/ecoli_k12_mg1655.fasta"
    output:
        "{sample}.CpG.tombo.stats",
	    "{sample}.CpG.tombo.per_read_stats"
    shell:
        "tombo resquiggle --dna {input.fast5} {input.ref} --processes 10 --overwrite && tombo detect_modifications alternative_model --dna --fast5-basedirs {input.fast5} --statistics-file-basename {wildcards.sample} --per-read-statistics-basename {wildcards.sample} --alternate-bases CpG --processes 8"

rule output_browser_files:
    input:
        fast5="data/{sample}",
        stats="{sample}.CpG.tombo.stats"
    output:
        "{sample}.coverage.minus.bedgraph",
        "{sample}.coverage.plus.bedgraph",
        "{sample}.dampened_fraction_modified_reads.minus.wig",
        "{sample}.dampened_fraction_modified_reads.plus.wig"
    shell:
        "tombo text_output browser_files --fast5-basedirs {input.fast5} --statistics-filename {input.stats} --file-types coverage dampened_fraction --browser-file-basename {wildcards.sample}"

rule wig_to_tsv:
    input:
        plus="{sample}.dampened_fraction_modified_reads.plus.wig",
        minus="{sample}.dampened_fraction_modified_reads.minus.wig"
    output:
        "tombo_results/{sample}_tombo-freq-only.tsv"
    script:
        "script_in_snakemake/wig2bed.py"

rule bedgraph_to_tsv:
    input:
        plus="{sample}.coverage.plus.bedgraph",
        minus="{sample}.coverage.minus.bedgraph"
    output:
        "tombo_results/{sample}_tombo-cov-only.tsv"
    script:
        "script_in_snakemake/bedgraph2bed.py"

rule combine_freq_and_cov:
    input:
        script="script_in_snakemake/run_tombo.R",
        freq="tombo_results/{sample}_tombo-freq-only.tsv",
        cov="tombo_results/{sample}_tombo-cov-only.tsv"
    output:
        "tombo_results/{sample}_tombo-freq-perCG.tsv"
    shell:
        "Rscript {input.script} {input.freq} {input.cov} {output}"

rule extract_per_read_results:
    input:
        "{sample}.CpG.tombo.per_read_stats"
    output:
        "tombo_results/{sample}_tombo-perRead-score.tsv"
    script:
        "script_in_snakemake/extract_tombo_per_read_results.py"
